#!/bin/sh

if [ -x ../gribtoqd ]; then
  PROG=../gribtoqd
  QDINFO=../qdinfo
else
  PROG=gribtoqd
  QDINFO=qdinfo
fi

version_suffix=
eccodes_version=$(codes_info -v)
case $eccodes_version in
    2.2*.*)
        version_suffix=2X
        ;;
    2.30.*)
        version_suffix=30
        ;;
esac

grep --quiet "#define WGS84 1" /usr/include/smartmet/newbase/NFmiGlobals.h
wgs84=$(expr $? == 0)
errors=0

for f in data/grib/*.grib*; do
    name=$(basename $f)
    search=results/gribtoqd/${name}
    if ! test -z "$version_suffix" ; then
        search="$search.$version_suffix $search"
    fi

    if [[ $wgs84 == 1 ]]; then
	search="$(for fn $search; do echo $fn.wgs84; done) $search"
    fi

    resultfile=$(for fn in $search ; do \
                     test -e $fn.sqd || test -L $fn.sqd && echo $fn.sqd; \
                 done | head -1)
    if test -z "$resultfile" ; then
	errors=$(($errors+1))
        echo "FAILED: no expected result file found for $f"
    else
        tmpfile=${resultfile}.tmp
        $PROG -c ../cnf/grib.conf -o $tmpfile $f
        cmp --quiet $resultfile $tmpfile
        ERR=$?
        printf '%-60s' "$name"
        if [[ $ERR -eq 0 ]]; then
	    echo OK
	    rm -f $tmpfile
        else
	    errors=$(($errors+1))
	    echo FAILED
	    $QDINFO -a -q $resultfile > ${tmpfile}.info_ok
	    $QDINFO -a -q $tmpfile > ${tmpfile}.info_fail
	    diff -u ${tmpfile}.info_ok ${tmpfile}.info_fail | head -100
        fi
    fi
done

echo $errors errors
exit $errors
